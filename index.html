<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#4f86ff" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
  <link rel="icon" href="./icons/icon-192.png">
  <meta name="format-detection" content="telephone=no" />
  <title>Basket Calendar — PWA</title>
  <meta name="description" content="Calendrier d'entraînement basket : PWA iPhone, cycle 7 jours, séance du jour, cases à cocher." />
  <style>
    /* ===== Reset & base ===== */
    *,*::before,*::after{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%;height:100%}
    :root{
      color-scheme:light dark;
      --bg:#070a12; --fg:#f5f7fb; --muted:#9aa3b2;
      --card:#0d1118; --border:#1a2232;
      --accent:#4f86ff; --accent2:#22d3ee;
      --brand-sky:#bfe9ff; --brand-ball:#ff8a00; --brand-seam:#cc6b00;
      --ok:#22c55e; --warn:#f59e0b;
      --radius:22px; --shadow:0 16px 60px rgba(0,0,0,.18);
      --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
    }
    @media (prefers-color-scheme:light){
      :root{
        --bg:#f7f8fc; --fg:#0b1220; --muted:#667085;
        --card:#ffffff; --border:#e6ebf4;
        --shadow:0 18px 40px rgba(0,0,0,.08);
      }
    }
    body{
      margin:0; height:100%;
      background:
        radial-gradient(1200px 800px at 50% -10%, color-mix(in lab, var(--accent) 18%, transparent), transparent 60%),
        radial-gradient(900px 700px at 10% 110%, color-mix(in lab, var(--accent2) 14%, transparent), transparent 60%),
        linear-gradient(180deg, color-mix(in lab, var(--bg) 96%, transparent), var(--bg) 70%);
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      letter-spacing:.2px;
    }
    /* Container tuned for iPhone 15 width */
    .container{ width:100%; max-width:430px; margin-inline:auto; }
    /* Aurora blobs */
    .aurora{ position:fixed; inset:-10% -10% auto -10%; height:60vh; pointer-events:none; z-index:0; filter: blur(60px); opacity:.5 }
    .blob{ position:absolute; border-radius:999px; }
    .b1{ width:420px; height:420px; left:8%; top:10%; background: color-mix(in lab, var(--accent) 40%, transparent); animation: float 14s ease-in-out infinite alternate }
    .b2{ width:520px; height:520px; right:10%; top:0%; background: color-mix(in lab, var(--accent2) 32%, transparent); animation: float 16s ease-in-out 1s infinite alternate-reverse }
    .b3{ width:380px; height:380px; left:30%; top:-6%; background: color-mix(in lab, #a78bfa 26%, transparent); animation: float 18s ease-in-out .3s infinite alternate }
    @keyframes float{ from{ transform: translateY(0)} to{ transform: translateY(-12px)} }
    @media (prefers-reduced-motion: reduce){ .aurora{ display:none } }

    /* ===== Splash / intro ===== */
    .splash{ position:fixed; inset:0; display:grid; place-items:center; z-index:50;
      background: radial-gradient(900px 600px at 50% -10%, color-mix(in lab, var(--accent) 22%, transparent), transparent 60%), var(--bg);
      transition: opacity .5s ease, visibility .5s ease;
    }
    .splash.hide{ opacity:0; visibility:hidden }
    .brand{ display:grid; place-items:center; gap:16px; text-align:center }
    .logoTile{ width:96px; height:96px; border-radius:26px; box-shadow:var(--shadow); position:relative }
    .pulse{ position:absolute; inset:-10px; border-radius:32px; filter:blur(24px); opacity:.25; background: radial-gradient(closest-side, var(--brand-sky), transparent); animation: pulse 1.2s ease-out infinite alternate }
    @keyframes pulse{ from{ transform: scale(1)} to{ transform: scale(1.05)} }
    .bar{ width:min(460px,70vw); height:6px; border-radius:999px; overflow:hidden; border:1px solid var(--border); background:#0003 }
    .bar i{ display:block; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent2)); animation: loadbar 1.1s ease forwards }
    @keyframes loadbar{ to{ width:100% } }
    .brand h1{ margin:0; font-size:20px; letter-spacing:.3px }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:5;
      padding: calc(12px + var(--safe-top)) 16px 12px;
      backdrop-filter:saturate(1.12) blur(10px);
      background: color-mix(in lab, var(--bg) 78%, transparent);
      border-bottom:1px solid var(--border);
    }
    .title{ display:flex; align-items:center; gap:12px }
    .logoWrap{ position:relative }
    .logoTileSm{ width:38px; height:38px; border-radius:14px; box-shadow:var(--shadow) }
    h1{ font-size:18px; margin:0 }
    .muted{ color:var(--muted) }

    /* ===== Layout ===== */
    main{ position:relative; z-index:1; padding:16px; padding-bottom: calc(18px + var(--safe-bottom)); }
    .card{ background: linear-gradient(180deg, color-mix(in lab, var(--card) 96%, transparent), color-mix(in lab, var(--card) 84%, transparent)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }
    .grid{ display:grid; gap:12px }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    input[type="date"]{
      appearance:none; border:1px solid var(--border); border-radius:14px; padding:10px 12px;
      font:inherit; background:var(--card); color:var(--fg);
    }
    .btn{ appearance:none; border:1px solid var(--border); background:color-mix(in lab, var(--accent) 12%, var(--card)); color:var(--fg); padding:12px 16px; border-radius:14px; font-weight:800; cursor:pointer; transition: transform .06s ease; touch-action: manipulation }
    .btn:active{ transform: translateY(1px) }
    .btn.primary{ background:linear-gradient(135deg, var(--accent), var(--accent2)); color:white; border-color: color-mix(in lab, var(--accent) 50%, black) }
    .btn.ghost{ background:transparent }
    .pill{ padding:6px 10px; border-radius:999px; background:color-mix(in lab, var(--accent) 16%, transparent); color:var(--accent); font-weight:800; font-size:12px }

    /* ===== Focus Day (single card, slide) ===== */
    .focus{ position:relative; }
    .focus .controls{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .ctrl{ width:44px; height:44px; border-radius:14px; display:grid; place-items:center; border:1px solid var(--border); background:linear-gradient(180deg, color-mix(in lab, var(--card) 96%, transparent), color-mix(in lab, var(--card) 86%, transparent)); font-weight:900 }
    .ctrl:active{ transform: scale(.98) }
    .stack{ position:relative; min-height:190px; }
    .pane{
      position:absolute; inset:0; border-radius:22px; border:1px solid var(--border); padding:14px; text-align:center;
      background: linear-gradient(180deg, color-mix(in lab, var(--card) 96%, transparent), color-mix(in lab, var(--card) 84%, transparent));
      box-shadow: var(--shadow);
      transform: translateX(0); opacity:1;
      transition: transform .28s cubic-bezier(.2,.7,.3,1), opacity .28s;
      display:grid; place-items:center;
    }
    .pane .big{ font-size:64px; font-weight:900; line-height:1; }
    .pane .sub{ margin-top:4px; font-size:12px; color:var(--muted) }
    .pane .title{ margin-top:8px; font-size:14px; color:var(--accent); font-weight:800 }
    /* slide classes */
    .enter-from-right{ transform: translateX(100%); opacity:.6 }
    .enter-from-left{ transform: translateX(-100%); opacity:.6 }
    .exit-to-left{ transform: translateX(-100%); opacity:.2 }
    .exit-to-right{ transform: translateX(100%); opacity:.2 }

    /* ===== Calendar (grid) ===== */
    .cal{ display:grid; grid-template-columns: repeat(7,1fr); gap:12px }
    .dow{ text-align:center; font-size:12px; color:var(--muted); position:sticky; top:0; z-index:1; background:linear-gradient(180deg, color-mix(in lab, var(--card) 96%, transparent), transparent); padding:6px 0 4px; }
    .calWrap{ max-height:50vh; overflow:auto; overscroll-behavior:contain; scroll-behavior:smooth; border-radius:18px; -webkit-overflow-scrolling: touch; }
    .fadeMask{ mask-image: linear-gradient(to bottom, transparent 0, black 16px, black calc(100% - 16px), transparent 100%); -webkit-mask-image: linear-gradient(to bottom, transparent 0, black 16px, black calc(100% - 16px), transparent 100%); }

    .day{
      position:relative; aspect-ratio:1/1; border:1px solid transparent; border-radius:22px;
      background:
        linear-gradient(180deg, color-mix(in lab, var(--card) 96%, transparent), color-mix(in lab, var(--card) 80%, transparent)) padding-box,
        linear-gradient(135deg, color-mix(in lab, var(--accent) 50%, transparent), color-mix(in lab, var(--accent2) 40%, transparent)) border-box;
      padding:8px; display:flex; flex-direction:column; justify-content:center; align-items:center;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
      overflow:hidden;
    }
    .day:hover{ transform: translateY(-2px); box-shadow:0 18px 46px rgba(0,0,0,.2) }
    .day:active{ transform: scale(.98) }
    .day .n{ font-weight:900; font-size:20px }
    .day .label{ margin-top:2px; font-size:10px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100% }
    .day .done{ position:absolute; right:8px; top:8px; width:9px; height:9px; border-radius:999px; background:var(--ok); box-shadow:0 0 0 4px color-mix(in lab, var(--ok) 20%, transparent) }
    .day.today{ box-shadow: 0 10px 32px color-mix(in lab, var(--accent) 24%, transparent) }

    .legend{ display:flex; gap:8px; align-items:center; justify-content:flex-end; font-size:12px; }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--ok); box-shadow:0 0 0 4px color-mix(in lab, var(--ok) 20%, transparent) }

    /* ===== Modal ===== */
    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:40; }
    .modal.open{ display:grid; }
    .overlay{ position:absolute; inset:0; background:color-mix(in lab, black 45%, transparent); backdrop-filter: blur(6px); animation: fade .2s both }
    .sheet{ position:relative; width:min(720px, 94vw); max-height:90vh; overflow:auto; border-radius:24px; border:1px solid var(--border);
      background:
        linear-gradient(180deg, color-mix(in lab, var(--card) 96%, transparent), color-mix(in lab, var(--card) 84%, transparent)) padding-box,
        linear-gradient(135deg, color-mix(in lab, var(--accent) 50%, transparent), color-mix(in lab, var(--accent2) 44%, transparent)) border-box;
      box-shadow: var(--shadow); animation: sheetIn .24s cubic-bezier(.2,.7,.3,1) both
    }
    .sheet header{ position:sticky; top:0; background:linear-gradient(180deg, color-mix(in lab, var(--card) 78%, transparent), transparent); border-bottom:1px solid var(--border); padding:14px 16px }
    .sheet .content{ padding:14px 16px 18px }
    .titleRow{ display:flex; justify-content:space-between; align-items:center; gap:10px }
    .x{ appearance:none; background:transparent; border:1px solid var(--border); width:38px; height:38px; border-radius:12px; display:grid; place-items:center; color:var(--muted); font-weight:900; }
    .list{ display:grid; gap:10px; padding:0; margin:0; list-style:none }
    .item{ display:flex; align-items:flex-start; gap:10px; border:1px dashed var(--border); border-radius:16px; padding:10px; background: color-mix(in lab, var(--card) 92%, transparent) }
    .check{ width:22px; height:22px; accent-color: var(--accent) }
    .disabled{ opacity:.5; pointer-events:none }
    @keyframes fade{ from{ opacity:0 } to{ opacity:1 } }
    @keyframes sheetIn{ from{ transform: translateY(10px); opacity:0 } to{ transform:none; opacity:1 } }

    /* ===== Reduced motion ===== */
    @media (prefers-reduced-motion: reduce){
      .splash, .day, .sheet, .pane{ animation: none !important; transition: none !important }
      .aurora{ display:none }
    }
  </style>
</head>
<body>

</head>
<body>
  <!-- Animated background blobs -->
  <div class="aurora" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>

  <!-- Splash screen with logo -->
  <div class="splash" id="splash">
    <div class="brand">
      <div class="logoTile">
        <div class="pulse"></div>
        <svg viewBox="0 0 100 100" width="96" height="96" style="border-radius:26px; display:block">
          <rect x="0" y="0" width="100" height="100" rx="26" fill="var(--brand-sky)"/>
          <ellipse cx="50" cy="66" rx="18" ry="6" fill="rgba(0,0,0,.12)"/>
          <circle cx="50" cy="50" r="22" fill="var(--brand-ball)" />
          <path d="M28,50 C40,52 60,48 72,50" stroke="var(--brand-seam)" stroke-width="3" fill="none" opacity=".85"/>
          <path d="M50,28 C48,40 52,60 50,72" stroke="var(--brand-seam)" stroke-width="3" fill="none" opacity=".85"/>
        </svg>
      </div>
      <h1>Basket Calendar</h1>
      <div class="bar"><i></i></div>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="title">
        <div class="logoWrap">
          <svg class="logoTileSm" viewBox="0 0 100 100">
            <rect x="0" y="0" width="100" height="100" rx="18" fill="var(--brand-sky)"/>
            <circle cx="50" cy="50" r="24" fill="var(--brand-ball)"/>
            <path d="M28,50 C40,52 60,48 72,50" stroke="var(--brand-seam)" stroke-width="4" fill="none" opacity=".85"/>
            <path d="M50,26 C48,40 52,60 50,74" stroke="var(--brand-seam)" stroke-width="4" fill="none" opacity=".85"/>
          </svg>
        </div>
        <div>
          <h1>Basket Calendar</h1>
          <div class="muted">Cycle de 7 jours · iPhone‑15 optimisé</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px; gap:10px">
        <div class="pill">Début de cycle</div>
        <input type="date" id="cycleStart" />
        <button class="btn primary" id="btnToday">Aujourd'hui</button>
      </div>
    </header>

    <main class="grid">
      <!-- Focus Day (single animated card) -->
      <section class="card focus" aria-label="Sélecteur de jour (focus)">
        <div class="controls">
          <button id="prevBtn" class="ctrl" aria-label="Jour précédent">◀</button>
          <div class="muted" id="focusMeta"></div>
          <button id="nextBtn" class="ctrl" aria-label="Jour suivant">▶</button>
        </div>
        <div class="stack" id="focusStack">
          <div class="pane" id="paneA">
            <div>
              <div class="big" id="numA">—</div>
              <div class="sub" id="subA">—</div>
              <div class="title" id="titleA">—</div>
              <div style="margin-top:10px"><button class="btn" id="btnA">Voir la séance</button></div>
            </div>
          </div>
          <div class="pane" id="paneB" style="display:none">
            <div>
              <div class="big" id="numB">—</div>
              <div class="sub" id="subB">—</div>
              <div class="title" id="titleB">—</div>
              <div style="margin-top:10px"><button class="btn" id="btnB">Voir la séance</button></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Month calendar -->
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row" style="align-items:baseline; gap:10px">
            <div style="font-weight:900; font-size:18px" id="monthLabel">Mois</div>
            <div class="muted" id="cycleHint"></div>
          </div>
          <div class="legend"><span class="dot"></span> fait</div>
        </div>

        <div id="calendarScroll" class="calWrap fadeMask" role="region" aria-label="Calendrier du mois">
          <div class="cal">
            <div class="dow">Lun</div><div class="dow">Mar</div><div class="dow">Mer</div><div class="dow">Jeu</div><div class="dow">Ven</div><div class="dow">Sam</div><div class="dow">Dim</div>
          </div>
          <div class="cal" id="calendarGrid"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: séance du jour -->
  <div class="modal" id="modal">
    <div class="overlay" id="overlay"></div>
    <div class="sheet">
      <header>
        <div class="titleRow">
          <div>
            <div style="font-size:12px; color:var(--muted)" id="modalDate"></div>
            <div style="font-size:16px; font-weight:900; color:var(--accent)" id="modalTitle">Séance</div>
          </div>
          <button class="x" id="close">✕</button>
        </div>
      </header>
      <div class="content">
        <ul class="list" id="workList"></ul>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="checkAll">Tout cocher</button>
          <button class="btn primary" id="saveClose">Terminer</button>
        </div>
        <div class="muted" id="infoNote" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
    }

    // ===== Plans 7 jours =====
    // Indexés Lundi->Dimanche (0..6) mais on sélectionnera par "jour réel de la semaine"
    const PLANS = [
      { title: "Lundi — Upper + Handle", items: [
        "Échauffement : corde 5′ + mobilité hanches/épaules/chevilles",
        "Handle 10′ : alterné bas 2×45s · cross 2×45s · combo 2×45s · main faible 2×45s (15s)",
        "Pompes 4×10–15 · pompes serrées 3×8–12 · dips 3×8–12 · KB press 3×8/bras",
        "Tirage : tractions 3–4×max OU KB row 4×10/bras",
        "Core : planche 3×45s + hollow 3×20s"
      ]},
      { title: "Mardi — Jambes + Plyo", items: [
        "Échauffement : corde 5′ + ponts 2×15",
        "Goblet squat KB 4×8–12 · fentes avant 3×10/j · fentes latérales 3×8/j · SDT JT KB 3×10/j",
        "Plyo : 3 tours — 30s squats sautés + 30s fentes sautées + 30s repos",
        "Agilité : pas rapides 3×30s",
        "Core : planche latérale 3×30s/côté · bird‑dog 2×12"
      ]},
      { title: "Mercredi — Core + Agilité", items: [
        "Handle 10′ : aveugle 2×60s · 2 ballons 3×45s (si possible)",
        "Core ×3 : mountain 30s · dead bug 12 · twist KB 20 · pont fessier 15",
        "Réactivité : bonds latéraux 3×30s · pas chassés 4×20m"
      ]},
      { title: "Jeudi — Dos/Tractions + Handle", items: [
        "Handle 10′ : main faible + changements de rythme",
        "Tractions 4×max OU KB row 4×12/bras · Y‑T‑W 3×10",
        "Curl KB 3×12 · planche avec reach 3×10/bras"
      ]},
      { title: "Vendredi — Full body + Cardio", items: [
        "Circuit ×4 : KB swing 12 · pompes 12 · goblet 12 · burpees 10 · sprint 20s (90s repos)"
      ]},
      { title: "Samedi — Terrain (90 min)", items: [
        "Échauffement 10′ : jogging léger · lay‑ups 2 mains · mobilité",
        "Form shooting : 5×10 près du cercle",
        "Mi‑distance : 5 spots ×10 (≥7/10 avant de reculer)",
        "3 points : 5 spots ×8 (≥6/8 si maîtrisé)",
        "Pull‑up après dribble : 5×6 (D/G)",
        "Catch & shoot en mouvement : 20",
        "Floaters 2×10 · Finitions main faible 20",
        "Rebond : 3×10 auto contre planche",
        "LF : 3×10 (≥80%)"
      ]},
      { title: "Dimanche — Repos actif / mobilité", items: [
        "Marche légère, mobilité, étirements profonds, tir libre plaisir"
      ]}
    ];

    // ===== Helpers dates =====
    const $ = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const pad = n => String(n).padStart(2,'0');
    const ISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const fromISO = iso => { const [Y,M,D]=iso.split('-').map(Number); return new Date(Y,M-1,D); };
    const addDays = (iso, n) => { const d = fromISO(iso); d.setDate(d.getDate()+n); return ISO(d); };
    const diffDays = (a,b)=> Math.floor((fromISO(b)-fromISO(a))/86400000);
    const mod = (n,m)=> ((n % m) + m) % m;
    const fmtMonth = (y,m)=> new Date(y,m,1).toLocaleDateString('fr-CH',{month:'long',year:'numeric'});
    const DOWS = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']; // 0..6
    // map weekday -> plan index (Mon->0 ... Sun->6)
    const PLAN_BY_WEEKDAY = {1:0, 2:1, 3:2, 4:3, 5:4, 6:5, 0:6};

    // ===== State =====
    let today = new Date();
    let todayISO = ISO(today);
    let viewYear = today.getFullYear();
    let viewMonth = today.getMonth();
    let cycleStart = localStorage.getItem('cycleStart') || todayISO;
    $('#cycleStart').value = cycleStart;
    let focusDate = todayISO; // focus on "today"

    // ===== Focus rendering & animation =====
    function dayIndex(iso){ return mod(diffDays(cycleStart, iso), 7); } // 0..6
    function planFor(iso){
      const wd = fromISO(iso).getDay(); // 0=Dim..6=Sam
      return PLANS[ PLAN_BY_WEEKDAY[wd] ] || { title:"Séance", items:[] };
    }
    function updatePane(paneId, iso){
      const d = fromISO(iso);
      const num = d.getDate();
      const sub = `${DOWS[d.getDay()]} · Jour ${dayIndex(iso)+1}/7`;
      const title = planFor(iso).title;
      $('#'+(paneId==='A'?'numA':'numB')).textContent = String(num);
      $('#'+(paneId==='A'?'subA':'subB')).textContent = sub;
      $('#'+(paneId==='A'?'titleA':'titleB')).textContent = title;
      const btn = $('#'+(paneId==='A'?'btnA':'btnB'));
      btn.onclick = ()=>{
        const isToday = iso === todayISO;
        openModal(iso, isToday);
      };
      $('#focusMeta').textContent = (iso===todayISO) ? "Aujourd'hui" : `Sélection : ${iso}`;
    }

    let showingA = true;
    function animateTo(targetISO, direction){ // direction: 'next' or 'prev'
      if(targetISO === focusDate) return;
      const currentPane = showingA ? $('#paneA') : $('#paneB');
      const nextPane = showingA ? $('#paneB') : $('#paneA');
      nextPane.style.display = 'grid';
      nextPane.classList.remove('enter-from-left','enter-from-right','exit-to-left','exit-to-right');
      currentPane.classList.remove('enter-from-left','enter-from-right','exit-to-left','exit-to-right');

      updatePane(showingA ? 'B' : 'A', targetISO);
      // prepare positions
      if(direction === 'next'){
        nextPane.classList.add('enter-from-right');
      } else {
        nextPane.classList.add('enter-from-left');
      }
      // force reflow
      void nextPane.offsetWidth;
      // animate
      if(direction === 'next'){
        currentPane.classList.add('exit-to-left');
      } else {
        currentPane.classList.add('exit-to-right');
      }
      nextPane.classList.remove('enter-from-right','enter-from-left');

      // when transition ends, hide old and swap
      const onEnd = ()=>{
        currentPane.style.display = 'none';
        currentPane.classList.remove('exit-to-left','exit-to-right');
        showingA = !showingA;
        focusDate = targetISO;
        currentPane.removeEventListener('transitionend', onEnd);
      };
      currentPane.addEventListener('transitionend', onEnd);
    }

    function renderFocus(initial=false){
      // Initial draw into paneA
      updatePane('A', focusDate);
      $('#paneA').style.display = 'grid';
      $('#paneB').style.display = 'none';
      showingA = true;
    }

    // ===== Calendar render =====
    function renderCalendar(){
      $('#monthLabel').textContent = fmtMonth(viewYear, viewMonth);
      $('#cycleHint').textContent = `Début: ${cycleStart}`;
      const grid = $('#calendarGrid'); grid.innerHTML = '';
      const first = new Date(viewYear, viewMonth, 1);
      const startOffset = (first.getDay() + 6) % 7; // Monday=0 for layout
      const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
      // leading blanks
      for(let i=0;i<startOffset;i++){ const ph = document.createElement('div'); grid.appendChild(ph); }
      let todayEl = null;
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(viewYear, viewMonth, d);
        const iso = ISO(date);
        const cell = document.createElement('button');
        cell.className = 'day'; cell.type = 'button';
        const dow = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'][(date.getDay()+6)%7];
        const jour = dayIndex(iso)+1;
        cell.innerHTML = `<div class="n">${d}</div><div class="label">${dow} · Jour ${jour}/7</div>`;
        const isToday = todayISO === iso;
        if(isToday){ cell.classList.add('today'); todayEl = cell; }
        const doneKey = `done:${iso}`;
        try{
          const saved = JSON.parse(localStorage.getItem(doneKey) || '[]');
          const planLen = (planFor(iso)?.items || []).length;
          if(saved.length && saved.filter(Boolean).length >= planLen && planLen>0){
            const dot = document.createElement('i'); dot.className='done'; cell.appendChild(dot);
          }
        }catch(e){}
        cell.addEventListener('click', ()=> {
          const direction = (iso > focusDate) ? 'next' : 'prev';
          animateTo(iso, direction);
          openModal(iso, iso===todayISO);
        });
        grid.appendChild(cell);
      }
      // Center today vertically in the scroll area
      const sc = $('#calendarScroll');
      if(sc && todayEl){
        const top = todayEl.offsetTop + todayEl.offsetHeight/2 - sc.clientHeight/2;
        sc.scrollTo({ top: Math.max(0, top), behavior: 'smooth' });
      } else if(sc) {
        sc.scrollTop = 0;
      }
    }

    // ===== Modal / séance du jour =====
    function openModal(iso, isToday){
      const plan = planFor(iso);
      $('#modal').classList.add('open');
      $('#modalDate').textContent = `Date : ${iso} · Jour ${dayIndex(iso)+1}/7`;
      $('#modalTitle').textContent = plan.title;
      const UL = $('#workList'); UL.innerHTML='';
      const key = `done:${iso}`;
      let saved = [];
      try{ saved = JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){}
      plan.items.forEach((txt, i)=>{
        const li = document.createElement('li'); li.className='item';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.className='check'; cb.checked = !!saved[i];
        if(!isToday) cb.disabled = true;
        cb.addEventListener('change', ()=>{ saved[i] = cb.checked; });
        const p = document.createElement('div'); p.textContent = txt;
        li.append(cb, p); UL.appendChild(li);
      });
      $('#checkAll').onclick = ()=>{
        const cbs = $$('#workList .check');
        const allChecked = cbs.every(c=>c.checked);
        cbs.forEach(c=>{ if(!c.disabled) c.checked = !allChecked; });
        saved = plan.items.map((_,i)=> cbs[i].checked );
      };
      $('#saveClose').onclick = ()=>{
        localStorage.setItem(key, JSON.stringify(saved));
        closeModal(); renderCalendar();
      };
      $('#infoNote').textContent = isToday ? "Coche les exercices à mesure. Tu peux revenir plus tard, c'est sauvegardé." : "Lecture seule pour ce jour (pas aujourd'hui).";
      // Close handlers
      $('#overlay').onclick = closeModal;
      $('#close').onclick = closeModal;
      function closeModal(){ $('#modal').classList.remove('open'); }
    }

    // ===== Controls =====
    $('#cycleStart').addEventListener('change', ()=>{
      if(!$('#cycleStart').value) return;
      cycleStart = $('#cycleStart').value;
      localStorage.setItem('cycleStart', cycleStart);
      renderCalendar(); renderFocus(true);
    });
    // "Aujourd'hui" => animation vers la date du téléphone (sans changer le cycleStart)
    $('#btnToday').addEventListener('click', ()=>{
      const direction = (todayISO > focusDate) ? 'next' : 'prev';
      animateTo(todayISO, direction);
    });
    $('#prevBtn').addEventListener('click', ()=> {
      const target = addDays(focusDate, -1);
      animateTo(target, 'prev');
    });
    $('#nextBtn').addEventListener('click', ()=> {
      const target = addDays(focusDate, 1);
      animateTo(target, 'next');
    });

    // ===== Init + Splash =====
    function hideSplash(){ const s = document.getElementById('splash'); if(s) s.classList.add('hide'); }
    window.addEventListener('load', ()=>{
      renderCalendar();
      renderFocus(true);
      setTimeout(hideSplash, 950);
    });
  
  </script>
</body>
</html>
